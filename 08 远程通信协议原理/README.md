### 1. tcp/ip的三次握手和四次挥手是什么概念，以及状态变化过程？
建立连接协议（三次握手）
![](https://i.imgur.com/jFmMGxu.png)

四次挥手
![](https://i.imgur.com/Dv48Ve5.png)

### 2. 建立连接需要3次，为什么断开连接需要4次？

 - 为服务端的LISTEN状态下的SOCKET当收到SYN报文的建连请求后，它可以把ACK和SYN（ACK起应答作用，而SYN起同步作用）放在一个报文里来发送。但关闭连接时，当收到对方的FIN报文通知时，它仅仅表示对方没有数据发送给你了；但未必你所有的数据都全部发送给对方了，所以你可以未必会马上会关闭SOCKET,也即你可能还需要发送一些数据给对方之后，再发送FIN报文给对方来表示你同意现在可以关闭连接了，所以它这里的ACK报文和FIN报文多数情况下都是分开发送的。

### 3. 三次握手有哪些不安全性？
- SYN 攻击，攻击者故意不完成三次握手，就是 Client 在短时间内伪造大量不存在的 IP 地址，并向Server 不断地发送 SYN 包，Server 回复确认包，并等待 Client 的确认，由于源地址是不存在的，因此，Server 需要不断重发直至超时，这些伪造的 SYN 包将产时间占用未连接队列，导致正常的 SYN 请求因为队列满而被丢弃，从而引起网络堵塞甚至系统瘫痪。
- 握手时插入伪造TCP包，攻击者监听服务器发出的SYN/ACK报文，然后攻击者向服务端发送Rst包，接着发送SYN包,假冒客户端发起新的连接，服务端响应新的连接，并发送连接响应包，攻击者再假冒客户端发送ACK包，从而导致整个连接过程被破坏。


### 4. TCP和UDP的区别？TCP是通过什么方式来保证可靠性的
- TCP是面向连接的，可靠的，缓慢的，可靠交付以及保证消息顺序的，而UDP是无连接的，不可靠的，没有序列保证，但是一个快速传输的协议。TCP头开销也比UDP高得多，因为它每个数据包中药发送更多的元数据。TCP头的大小是20个字节，而UDP头大小是8个字节。
- TCP协议支持数据报传输可靠性的主要方法是确认、超时、重传、校验和以及流量控制。


### 5. tcp四层网络模型和osi七层网络模型分别是什么？以及每一层的作用

TCP4层模型如下：

	  1. 应用层：各种服务及应用程序通过该层利用网络，常用协议：HTTP,FTP,SMTP
	  2. 传输层：确认数据传输进行纠错处理，常用协议：TCP UDP
	  3. 网络层：负责数据传输、路径及地址选择，常用协议：IP ARP(地址解析协议）
	  4. 网络接口：是针对不同物理网络的连接形式的协议：Erthernet


OSI的7层模型如下：

	1. 应用层：应用程序间沟通的层，例如telnet，HTTP,FTP,WWW,NFS,SMTP等都属于这一层
	2. 表示层：这一层的主要功能是定义数据格式及加密。HTTP
	3. 会话层：建立通信链接，保持会话过程通信链接的畅通，同步两个节点之间的对话，决定通信是否被中断以及通信中断时决定从何处重新发送。例如RPC,SSH,
	4. 传输层：向高层提供可靠的端到端的网络数据流服务。例如TCP、UDP
	5. 网络层：对端到端的包传输进行定义，他定义了能够标识所有结点的逻辑地址，还定义了路由实现的方式和学习的方式。例如IP,ICMPP,ARP,RARP,BGP
	6. 数据链路层：通过物理网络链路提供可靠的数据传输。WIFI,PPP
	7. 物理层：将信息编码成电流脉冲或其它信号用于网上传输。光纤

### 6. 什么是滑动窗口协议？它的实现原理是什么？
- 滑动窗口协议用于网络数据传输时的流量控制，以避免拥塞的发生。它本质上是描述接收方的TCP数据报缓冲区大小的数据，发送方根据这个数据来计算自己最多能发送多长的数据，如果发送方收到接收方的窗口大小为0的TCP数据报，那么发送方将停止发送数据，等到接收方发送窗口大小不为0的数据报的到来
- 基本原理就是在任意时刻，发送方都维持了一个连续的允许发送的帧的序号，称为发送窗口；同时，接收方也维持了一个连续的允许接收的帧的序号，称为接收窗口。发送窗口和接收窗口的序号的上下界不一定要一样，甚至大小也可以不同。不同的滑动窗口协议窗口大小一般不同。发送方窗口内的序列号代表了那些已经被发送，但是还没有被确认的帧，或者是那些可以被发送的帧。

### 7. 服务器上TIME_WAIT状态的连接过多，怎么解决？
如发现系统存在大量TIME_WAIT状态的连接，通过调整内核参数解决：
编辑内核文件/etc/sysctl.conf，加入以下内容：

    net.ipv4.tcp_syncookies = 1 表示开启SYN Cookies。当出现SYN等待队列溢出时，启用cookies来处理，可防范少量SYN攻击，默认为0，表示关闭；
    net.ipv4.tcp_tw_reuse = 1 表示开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接，默认为0，表示关闭；
    net.ipv4.tcp_tw_recycle = 1 表示开启TCP连接中TIME-WAIT sockets的快速回收，默认为0，表示关闭。
    net.ipv4.tcp_fin_timeout 修改系默认的 TIMEOUT 时间

然后执行 /sbin/sysctl -p 让参数生效.

/etc/sysctl.conf是一个允许改变正在运行中的Linux系统的接口，它包含一些TCP/IP堆栈和虚拟内存系统的高级选项，修改内核参数永久生效。
简单来说，就是打开系统的TIMEWAIT重用和快速回收。

如果以上配置调优后性能还不理想，可继续修改一下配置：

    vi /etc/sysctl.conf
    net.ipv4.tcp_keepalive_time = 1200 
    #表示当keepalive起用的时候，TCP发送keepalive消息的频度。缺省是2小时，改为20分钟。
    net.ipv4.ip_local_port_range = 1024 65000 
    #表示用于向外连接的端口范围。缺省情况下很小：32768到61000，改为1024到65000。
    net.ipv4.tcp_max_syn_backlog = 8192 
    #表示SYN队列的长度，默认为1024，加大队列长度为8192，可以容纳更多等待连接的网络连接数。
    net.ipv4.tcp_max_tw_buckets = 5000 
    #表示系统同时保持TIME_WAIT套接字的最大数量，如果超过这个数字，TIME_WAIT套接字将立刻被清除并打印警告信息。
    #默认为180000，改为5000。对于Apache、Nginx等服务器，上几行的参数可以很好地减少TIME_WAIT套接字数量，但是对于 Squid，效果却不大。此项参数可以控制TIME_WAIT套接字的最大数量，避免Squid服务器被大量的TIME_WAIT套接字拖死。

### 8. 什么是NIO、BIO、AIO？他们的区别？
- BIO：同步阻塞BIO，服务端程序要想同时处理多个套接字的数据读取，在等待接收连接请求的主线程之外，还要为每一个建立好的连接分配一个新的线程进行处理。适用于连接数目比较小，并且一次发送大量数据的场景，这种方式对服务器资源要求比较高，并发局限于应用中。
- NIO：同步非阻塞IO,服务器的实现模式是多个请求一个线程，即请求会注册到多路复用器Selector上，多路复用器轮询到连接有IO请求时才启动一个线程处理。
- AIO:异步非阻塞IO，当进行读写操作时，只须直接调用API的read或write方法即可。这两种方法均为异步的，对于读操作而言，当有流可读取时，操作系统会将可读的流传入read方法的缓冲区，并通知应用程序；对于写操作而言，当操作系统将write方法传递的流写入完毕时，操作系统主动通知应用程序。  即可以理解为，read/write方法都是异步的，完成后会主动调用回调函数。

### 9. 了解过多路复用吗？它是一个什么实现原理？
- 多路复用技术分为频分多路复用、时分多路复用、波分多路复用、码分多路复用。
- I/O 多路复用的本质是通过一种机制（系统内核缓冲 I/O 数据），让单个进程可以监视多个文件描述符，一旦某个描述符就绪（一般是读就绪或写就绪），能够通知程序进行相应的读写操作。


### 10. epool和select的区别是什么？

- select机制刚开始的时候，需要把fd_set从用户空间拷贝到内核空间，并且检测的fd数是有限制的，由FD_SETSIZE设置，一般是1024。
检测的时候，根据timeout，遍历fd_set表，把活跃的fd(可读写或者错误)，拷贝到用户空间，再在用户空间依次处理相关的fd。

- epool是select和poll的改进版本,epool支持一个进程打开大数目的socket描述符,一般1GB的内存有10万多的FD数，具体数目可以cat /proc/sys/fs/file-max查看；IO效率不随FD数目增加而线性下降；使用mmap加速内核与用户空间的消息传递。


